# Container Escape Vulnerability Lab
apiVersion: v1
kind: Namespace
metadata:
  name: container-escape-lab
  labels:
    name: container-escape-lab
    purpose: container-escape-testing
    security-level: critical
---
# VULNERABLE: Service account with excessive permissions for container escape
apiVersion: v1
kind: ServiceAccount
metadata:
  name: escape-sa
  namespace: container-escape-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for container escape
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: escape-role
  namespace: container-escape-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: escape-role-binding
  namespace: container-escape-lab
subjects:
- kind: ServiceAccount
  name: escape-sa
  namespace: container-escape-lab
roleRef:
  kind: Role
  name: escape-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Privileged pod for container escape testing
apiVersion: v1
kind: Pod
metadata:
  name: privileged-escape-pod
  namespace: container-escape-lab
  labels:
    app: privileged-escape
    security-level: critical
spec:
  serviceAccountName: escape-sa
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
    privileged: true  # VULNERABLE: Privileged container
    capabilities:
      add:
      - ALL  # VULNERABLE: All capabilities
      drop: []
    readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
  containers:
  - name: escape-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: HOST_ACCESS
      value: "enabled"
    - name: PRIVILEGE_ESCALATION
      value: "allowed"
    - name: CONTAINER_ESCAPE
      value: "possible"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var
      mountPath: /host/var
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false
    - name: host-var-lib
      mountPath: /host/var/lib
      readOnly: false
    - name: host-etc-kubernetes
      mountPath: /host/etc/kubernetes
      readOnly: false
    - name: host-var-lib-kubelet
      mountPath: /host/var/lib/kubelet
      readOnly: false
    - name: host-etc-docker
      mountPath: /host/etc/docker
      readOnly: false
    - name: host-var-lib-docker
      mountPath: /host/var/lib/docker
      readOnly: false
  volumes:
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-var
    hostPath:
      path: /var  # VULNERABLE: Host path mount
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  - name: host-var-run
    hostPath:
      path: /var/run
  - name: host-var-lib
    hostPath:
      path: /var/lib
  - name: host-etc-kubernetes
    hostPath:
      path: /etc/kubernetes
  - name: host-var-lib-kubelet
    hostPath:
      path: /var/lib/kubelet
  - name: host-etc-docker
    hostPath:
      path: /etc/docker
  - name: host-var-lib-docker
    hostPath:
      path: /var/lib/docker
  restartPolicy: Always
---
# VULNERABLE: Pod with Docker socket access
apiVersion: v1
kind: Pod
metadata:
  name: docker-socket-pod
  namespace: container-escape-lab
  labels:
    app: docker-socket
    security-level: critical
spec:
  serviceAccountName: escape-sa
  containers:
  - name: docker-socket-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: DOCKER_SOCKET_ACCESS
      value: "enabled"
    - name: CONTAINER_ESCAPE
      value: "possible"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: docker-socket
      mountPath: /var/run/docker.sock
      readOnly: false  # VULNERABLE: Writable Docker socket
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock  # VULNERABLE: Docker socket mount
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Pod with cgroup escape vulnerability
apiVersion: v1
kind: Pod
metadata:
  name: cgroup-escape-pod
  namespace: container-escape-lab
  labels:
    app: cgroup-escape
    security-level: critical
spec:
  serviceAccountName: escape-sa
  containers:
  - name: cgroup-escape-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: CGROUP_ESCAPE
      value: "possible"
    - name: HOST_ACCESS
      value: "enabled"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  - name: host-var-run
    hostPath:
      path: /var/run
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Pod with kernel module access
apiVersion: v1
kind: Pod
metadata:
  name: kernel-module-pod
  namespace: container-escape-lab
  labels:
    app: kernel-module
    security-level: critical
spec:
  serviceAccountName: escape-sa
  containers:
  - name: kernel-module-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: KERNEL_MODULE_ACCESS
      value: "enabled"
    - name: CONTAINER_ESCAPE
      value: "possible"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-lib-modules
      mountPath: /lib/modules
      readOnly: false  # VULNERABLE: Writable kernel modules
    - name: host-usr
      mountPath: /host/usr
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-bin
      mountPath: /host/bin
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-sbin
      mountPath: /host/sbin
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: host-lib-modules
    hostPath:
      path: /lib/modules  # VULNERABLE: Kernel modules mount
  - name: host-usr
    hostPath:
      path: /usr  # VULNERABLE: Host path mount
  - name: host-bin
    hostPath:
      path: /bin  # VULNERABLE: Host path mount
  - name: host-sbin
    hostPath:
      path: /sbin  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Service exposing container escape pods
apiVersion: v1
kind: Service
metadata:
  name: container-escape-service
  namespace: container-escape-lab
  labels:
    app: container-escape
spec:
  type: NodePort
  selector:
    app: privileged-escape
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30081
    protocol: TCP
---
# VULNERABLE: Secrets for container escape testing
apiVersion: v1
kind: Secret
metadata:
  name: escape-secrets
  namespace: container-escape-lab
type: Opaque
data:
  host-password: dG9vcg==  # base64: toor
  root-key: c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDNw==  # base64: ssh-rsa AAAAB3NzaC1yc2EAAAADAQ
  escape-token: ZXNjYXBlLXRva2VuLTEyMzQ1  # base64: escape-token-12345
---
# VULNERABLE: ConfigMap with container escape information
apiVersion: v1
kind: ConfigMap
metadata:
  name: escape-config
  namespace: container-escape-lab
data:
  escape.info: |
    Container escape techniques available:
    - Privileged container escape
    - Docker socket escape
    - Cgroup escape
    - Kernel module escape
    - Host filesystem access
  host.access: enabled
  privilege.escalation: allowed
  container.escape: possible
  security.level: critical
